<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>åˆ—è¡¨å¼å–®å­—èƒŒèª¦å·¥å…·</title>

<style>
/* --- åŸºç¤è¨­å®šä¸è®Š --- */
body{
  margin:0;padding:18px; background:#a3d2f1;
  font-family:system-ui,"Noto Sans TC", sans-serif;
  user-select: none;
}
.container{max-width:900px;margin:auto;}
header h1{
  margin:0;padding:10px 14px;background:#fff;border-radius:8px;
  font-size:20px;box-shadow:0 6px 16px rgba(0,0,0,.06);
}

/* --- ä¿®æ”¹é‡é»ï¼šé¡¯ç¤ºå€ --- */
.display{
  position:relative;margin-top:14px;background:#fff;
  border-radius:12px;border:1px solid #e6edff;
  box-shadow:0 8px 24px rgba(0,0,0,.06);
  /* å¢åŠ  padding-top é¿é–‹é€²åº¦æ–‡å­—ï¼Œåº•éƒ¨ç•™ç™½ */
  padding: 40px 0 0 0; 
  height:500px; 
  display:flex;
  flex-direction:column;
  overflow:hidden; /* ç¦æ­¢æ²å‹• */
  cursor: pointer;
}

/* åˆ—è¡¨å®¹å™¨ */
#listContainer {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden; /* ç¢ºä¿å…§å®¹ä¸è¶…å‡º */
  justify-content: flex-start; /* å¾é ‚éƒ¨é–‹å§‹æ’åˆ— */
}

/* --- ä¿®æ”¹é‡é»ï¼šå–®å­—åˆ—ç·Šå¯†æ’åˆ— --- */
.word-row {
  display: flex;
  align-items: center;
  /* ç¸®å° Padding è®“æ’åˆ—æ›´ç·Šå¯† */
  padding: 8px 16px; 
  /* åƒ…ç”¨åº•ç·šåˆ†éš”ï¼Œä¸ç•™ç©ºéš™ */
  border-bottom: 1px solid #e0e0e0; 
  background: #fff;
  transition: background 0.2s;
  /* é˜²æ­¢è¢«å£“ç¸® */
  flex-shrink: 0; 
  /* é è¨­ä½”ç”¨ç©ºé–“ï¼Œç¢ºä¿è¨ˆç®—é«˜åº¦æº–ç¢º */
  min-height: auto; 
}

.word-row:last-child {
  border-bottom: none; /* æœ€å¾Œä¸€å€‹ä¸ç”¨åº•ç·š */
}

.word-row:hover {
  background: #f4f9ff;
}

/* å·¦å´å–®å­— */
.row-word {
  flex: 0 0 30%; 
  font-size: 18px;
  font-weight: 700;
  color: #0b63d6;
  padding-right: 10px;
  word-break: break-word;
}

/* ä¸­é–“è§£é‡‹å€ */
.row-def {
  flex: 1;
  font-size: 15px;
  color: #333;
  line-height: 1.4;
  opacity: 0; /* é è¨­çœ‹ä¸åˆ°ä½†ä½”ä½ï¼Œç¢ºä¿æ’ç‰ˆé«˜åº¦ä¸€è‡´ */
  transition: opacity 0.2s;
}

.word-row.revealed .row-def {
  opacity: 1;
}

.def-part { font-size: 12px; color: #888; margin-right: 4px; border:1px solid #eee; padding:1px 4px; border-radius:4px;}
.def-text { font-weight: 600; }

/* å³å´ç¨ç«‹ä¸ç†ŸæŒ‰éˆ• */
.row-hard-btn {
  flex: 0 0 28px;
  height: 28px;
  margin-left: 10px;
  border-radius: 50%;
  border: 1px solid #eee;
  background: #fff;
  color: #ccc;
  font-size: 16px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
.row-hard-btn:hover { background: #fff6f0; color: #ff9f7d; }
.row-hard-btn.active { background: #fff6f0; color: #d65a00; border-color: #ffd9cc; }

/* å…¶ä»–ä»‹é¢å…ƒç´  */
.icon-btn{ position:absolute;top:10px;right:10px;width:30px;height:30px;border-radius:50%;border:none;background:#eef4ff;color:#0b63d6;font-size:16px;cursor:pointer;z-index: 10; }
.progress{ position:absolute;top:14px;left:18px;font-size:14px;color:#666;font-weight:600;z-index: 10; }
.hint-text { position:absolute; top:14px; left:50%; transform:translateX(-50%); font-size:12px; color:#aaa; pointer-events:none; }

/* æ§åˆ¶å€èˆ‡å…¨è¢å¹•è¨­å®š */
.controls{ display:flex; flex-direction:column; gap:8px; margin-top:12px; }
.controls-row{ display:flex; gap:8px; align-items:center; }
.controls button, .controls input{ height:36px; padding:0 12px; border-radius:8px; border:1px solid #d7e6fd;background:#fff; color:#0b63d6;font-weight:700; cursor:pointer; font-size:14px; }
.controls-row:first-child button{ flex:1; }
.adder{ margin-top:14px;background:#fff;padding:14px; border-radius:10px;border:1px solid #eef3fb; }
.adder button{ padding:8px 14px;border-radius:8px;border:1px solid #d7e6fd; background:#fff;color:#0b63d6;font-weight:700;cursor:pointer; }
.fullscreen .display{ position:fixed;inset:0;height:100%;z-index:9999; margin:0; border-radius:0; border:none; padding-top: 60px; }
.fullscreen header, .fullscreen .controls, .fullscreen .adder{display:none;}
.toggle-btn.active{ background:#eef4ff;border-color:#0b63d6; }
#jumpInput{ padding:0 10px; flex:1; }
#exportHard{ min-width:150px; }
</style>
</head>

<body>
<div class="container" id="root">
<header><h1>åˆ—è¡¨å¼å–®å­—èƒŒèª¦å·¥å…·</h1></header>
<div class="display" id="display">
  <div class="progress" id="progress">0 / 0</div>
  <div class="hint-text" id="hintText">é»æ“ŠæŸ¥çœ‹ç­”æ¡ˆ â†’ å†é»ä¸‹ä¸€é </div>
  <button class="icon-btn" id="fsBtn" title="å…¨è¢å¹•">â›¶</button>
  <div id="listContainer">
    <div style="text-align:center;color:#999;margin-top:100px;">å°šæœªè¼‰å…¥å–®å­—è¡¨</div>
  </div>
</div>
<div class="controls">
  <div class="controls-row">
    <button id="prevPage">ä¸Šä¸€é </button>
    <button id="nextPage">ä¸‹ä¸€é </button>
    <button class="toggle-btn" id="toggleChineseBtn" title="é–‹å•Ÿå¾Œé è¨­é¡¯ç¤ºä¸­æ–‡">ä¸€å¾‹é¡¯ç¤ºä¸­æ–‡</button>
  </div>
  <div class="controls-row">
    <input type="text" id="jumpInput" placeholder="è¼¸å…¥å–®å­—ç·¨è™Ÿ (1ï½n)">
    <button id="jumpBtn">è·³è½‰</button>
  </div>
  <div class="controls-row">
    <button id="exportHard">åŒ¯å‡ºä¸ç†Ÿå–®å­— (0)</button>
  </div>
</div>
<div class="adder">
  <strong>åŠ å…¥å–®å­—è¡¨</strong>
  <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
    <select id="vocabSelect" style="min-width:200px;padding:6px;border-radius:6px;border:1px solid #e6eefc;"></select>
    <button id="loadVocab">è¼‰å…¥é¸å®š</button>
    <button id="pasteJson">ğŸ“‹ å‰ªè²¼ç°¿</button>
    <button id="openFile">ğŸ“ é¸æ“‡æª”æ¡ˆ</button>
    <input type="file" id="fileInput" accept=".json" hidden>
    <button id="loadHardVocab">è¼‰å…¥ä¸ç†Ÿæ¸…å–®</button>
  </div>
</div>
</div>

<script>
/* ===== DOM ===== */
const root = document.getElementById("root");
const display = document.getElementById("display");
const listContainer = document.getElementById("listContainer");
const progress = document.getElementById("progress");
const hintText = document.getElementById("hintText");
const fsBtn = document.getElementById("fsBtn");
const prevPage = document.getElementById("prevPage");
const nextPage = document.getElementById("nextPage");
const toggleChineseBtn = document.getElementById("toggleChineseBtn");
const jumpInput = document.getElementById("jumpInput");
const jumpBtn = document.getElementById("jumpBtn");
const pasteJson = document.getElementById("pasteJson");
const openFile = document.getElementById("openFile");
const fileInput = document.getElementById("fileInput");
const vocabSelect = document.getElementById("vocabSelect");
const loadVocabBtn = document.getElementById("loadVocab");
const exportHard = document.getElementById("exportHard");
const loadHardVocab = document.getElementById("loadHardVocab");

/* ===== State ===== */
let words = [];
let currentStartIndex = 0; // ç•¶å‰é é¢ç¬¬ä¸€å€‹å–®å­—çš„ç´¢å¼•
let historyStack = [0]; // ç´€éŒ„æ¯ä¸€é çš„èµ·å§‹ç´¢å¼•ï¼Œç”¨æ–¼ä¸Šä¸€é åŠŸèƒ½
let visibleCount = 0;   // ç•¶å‰é é¢å¯¦éš›èƒ½æ”¾å¹¾å€‹å–®å­—
let showChineseAlways = false; 
let fullscreen = false;
let pageRevealed = false; 
let hardList = [];

try {
  hardList = JSON.parse(localStorage.getItem("hardList") || "[]");
  if (!Array.isArray(hardList)) hardList = [];
} catch { hardList = []; }

/* ===== æ ¸å¿ƒ Render é‚è¼¯ (å‹•æ…‹å¡«å……) ===== */
function render() {
  if (!words.length) {
    listContainer.innerHTML = '<div style="text-align:center;color:#999;margin-top:100px;">å°šæœªè¼‰å…¥å–®å­—è¡¨</div>';
    progress.textContent = "0 / 0";
    hintText.style.display = 'none';
    return;
  }
  hintText.style.display = 'block';
  listContainer.innerHTML = "";
  
  // é‡ç½®è¨ˆæ•¸
  visibleCount = 0;
  
  // å˜—è©¦å¾ currentStartIndex é–‹å§‹åŠ å…¥å–®å­—
  for (let i = currentStartIndex; i < words.length; i++) {
    const w = words[i];
    const isHard = hardList.some(h => h.word === w.word);
    
    // å»ºç«‹ Row
    const row = document.createElement("div");
    row.className = "word-row";
    // å³ä½¿æ˜¯éš±è—æ¨¡å¼ï¼Œä¹Ÿå¿…é ˆè®“å…§å®¹ä½”ä½ (opacity: 0)ï¼Œé€™æ¨£åˆ‡æ›é¡¯ç¤ºæ™‚æ‰ä¸æœƒçˆ†æ¡†
    if (showChineseAlways || pageRevealed) row.classList.add("revealed");

    let defText = "";
    if(w.definitions && w.definitions.length > 0){
        const d = w.definitions[0];
        defText = `<span class="def-part">${d.part_of_speech}</span><span class="def-text">${d.meaning_zh}</span>`;
    }

    row.innerHTML = `
      <div class="row-word">${w.word}</div>
      <div class="row-def">${defText}</div>
      <button class="row-hard-btn ${isHard ? 'active' : ''}">
        ${isHard ? 'â˜…' : 'â˜†'}
      </button>
    `;

    // ç¶å®šä¸ç†ŸæŒ‰éˆ•
    const btn = row.querySelector('.row-hard-btn');
    btn.onclick = (e) => {
      e.stopPropagation(); 
      toggleHardWord(w, btn);
    };

    // åŠ å…¥å®¹å™¨
    listContainer.appendChild(row);

    // --- é—œéµä¿®æ”¹ï¼šæª¢æŸ¥é«˜åº¦æ˜¯å¦æº¢å‡º ---
    if (listContainer.scrollHeight > listContainer.clientHeight) {
      // æº¢å‡ºäº†ï¼ç§»é™¤é€™ä¸€å€‹ï¼Œä¸¦çµæŸè¿´åœˆ
      listContainer.removeChild(row);
      break;
    } else {
      // æ²’æº¢å‡ºï¼Œç®—å…¥æœ‰æ•ˆé¡¯ç¤º
      visibleCount++;
    }
  }

  // æ›´æ–°é€²åº¦æ¢
  const endIdx = currentStartIndex + visibleCount;
  progress.textContent = `Words ${currentStartIndex + 1} - ${endIdx} / ${words.length}`;
  
  // æ›´æ–°æç¤º
  if(showChineseAlways) hintText.textContent = "é»æ“Šç¿»ä¸‹ä¸€é ";
  else hintText.textContent = pageRevealed ? "å†æ¬¡é»æ“Šç¿»ä¸‹ä¸€é " : "é»æ“ŠæŸ¥çœ‹ç­”æ¡ˆ";
  
  updateHardExportText();
}

/* ===== é¡¯ç¤ºå€é»æ“Šäº’å‹• ===== */
display.addEventListener("click", (e) => {
  if(!words.length) return;
  if(e.target.closest("button")) return;

  if(showChineseAlways) {
    goNextPage();
  } else {
    if(!pageRevealed) {
      pageRevealed = true;
      // é€™è£¡ä¸éœ€è¦é‡æ–° render æ•´å€‹åˆ—è¡¨ï¼ˆæ•ˆç‡è¼ƒé«˜ï¼‰ï¼Œåªéœ€åŠ ä¸Š class
      const rows = listContainer.querySelectorAll('.word-row');
      rows.forEach(r => r.classList.add('revealed'));
      hintText.textContent = "å†æ¬¡é»æ“Šç¿»ä¸‹ä¸€é ";
    } else {
      goNextPage();
    }
  }
});

/* ===== ç¿»é é‚è¼¯ ===== */
function goNextPage() {
  // æª¢æŸ¥æ˜¯å¦å·²ç¶“é¡¯ç¤ºå®Œæœ€å¾Œä¸€å€‹å–®å­—
  if (currentStartIndex + visibleCount >= words.length) {
    // === ä¿®æ”¹é»ï¼šå›åˆ°ç¬¬ä¸€é  ===
    currentStartIndex = 0;
    historyStack = [0]; // é‡ç½®ä¸Šä¸€é çš„æ­·å²ç´€éŒ„
    pageRevealed = false;
    render();
    return;
  }

  // æ­£å¸¸çš„ä¸‹ä¸€é é‚è¼¯
  const nextIdx = currentStartIndex + visibleCount;
  historyStack.push(nextIdx); // å­˜å…¥æ­·å²
  currentStartIndex = nextIdx;
  pageRevealed = false;
  render();
}


function goPrevPage() {
  if (historyStack.length <= 1) {
    // å·²åœ¨ç¬¬ä¸€é  (stack è‡³å°‘æœ‰ [0])
    return;
  }
  historyStack.pop(); // ç§»é™¤ç•¶å‰é èµ·å§‹é»
  currentStartIndex = historyStack[historyStack.length - 1]; // è®€å–ä¸Šä¸€é èµ·å§‹é»
  pageRevealed = false;
  render();
}

prevPage.onclick = (e) => { e.stopPropagation(); goPrevPage(); };
nextPage.onclick = (e) => { e.stopPropagation(); goNextPage(); };

/* ===== è·³è½‰é‚è¼¯ (æ”¹ç‚ºè·³è½‰åˆ°æŒ‡å®šå–®å­—ç·¨è™Ÿ) ===== */
jumpBtn.onclick = (e) => {
  e.stopPropagation();
  const val = parseInt(jumpInput.value);
  if (!isNaN(val) && val >= 1 && val <= words.length) {
    // é‡ç½®æ­·å²å †ç–Šï¼Œç›´æ¥è·³åˆ°è©²å–®å­—ç‚ºèµ·å§‹
    historyStack = [val - 1];
    currentStartIndex = val - 1;
    pageRevealed = false;
    render();
    jumpInput.value = "";
  } else {
    alert(`è«‹è¼¸å…¥å–®å­—ç·¨è™Ÿ (1 ~ ${words.length})`);
  }
};

/* ===== å…¶ä»–åŠŸèƒ½ (ç¶­æŒåŸæ¨£) ===== */
toggleChineseBtn.onclick = (e) => {
  e.stopPropagation();
  showChineseAlways = !showChineseAlways;
  toggleChineseBtn.classList.toggle("active", showChineseAlways);
  toggleChineseBtn.textContent = showChineseAlways ? "éš±è—ä¸­æ–‡" : "ä¸€å¾‹é¡¯ç¤ºä¸­æ–‡";
  if(!showChineseAlways) pageRevealed = false;
  render();
};

function toggleHardWord(wordObj, btnEl) {
  const idx = hardList.findIndex(h => h.word === wordObj.word);
  if (idx >= 0) {
    hardList.splice(idx, 1);
    btnEl.classList.remove("active");
    btnEl.textContent = "â˜†";
  } else {
    hardList.push(wordObj);
    btnEl.classList.add("active");
    btnEl.textContent = "â˜…";
  }
  localStorage.setItem("hardList", JSON.stringify(hardList));
  updateHardExportText();
}

function updateHardExportText() {
  exportHard.textContent = `åŒ¯å‡ºä¸ç†Ÿå–®å­— (${hardList.length})`;
}

exportHard.onclick = (e) => {
  e.stopPropagation();
  if (!hardList.length) return alert("æ¸…å–®ç‚ºç©º");
  const blob = new Blob([JSON.stringify(hardList, null, 2)], {type: "application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "hard_words.json";
  a.click();
};

loadHardVocab.onclick = (e) => {
  e.stopPropagation();
  if (!hardList.length) return alert("æ²’æœ‰ç´€éŒ„çš„ä¸ç†Ÿå–®å­—");
  words = JSON.parse(JSON.stringify(hardList));
  currentStartIndex = 0;
  historyStack = [0];
  pageRevealed = false;
  render();
};

async function loadData(data) {
  if (!Array.isArray(data)) return alert("æ ¼å¼éŒ¯èª¤");
  words = data;
  currentStartIndex = 0;
  historyStack = [0];
  pageRevealed = false;
  render();
}

pasteJson.onclick = async (e) => {
  e.stopPropagation();
  try {
    const text = await navigator.clipboard.readText();
    loadData(JSON.parse(text));
  } catch { alert("å‰ªè²¼ç°¿å…§å®¹ç„¡æ•ˆ"); }
};

openFile.onclick = (e) => { e.stopPropagation(); fileInput.click(); };
fileInput.onchange = () => {
  const file = fileInput.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try { loadData(JSON.parse(e.target.result)); }
    catch { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
  };
  reader.readAsText(file);
};

/* å°ˆæ¡ˆåˆ—è¡¨è¼‰å…¥ */
async function initVocabList() {
  try {
    const res = await fetch("vocabulary/list.json");
    if (!res.ok) throw 0;
    const list = await res.json();
    vocabSelect.innerHTML = "";
    list.forEach(item => {
      const opt = document.createElement("option");
      opt.value = item.path;
      opt.textContent = item.label || item.path;
      vocabSelect.appendChild(opt);
    });
    if(list.length > 0) loadVocabFile(list[0].path);
  } catch (e) { console.log("Init list failed", e); }
}

async function loadVocabFile(path) {
  try {
    const res = await fetch(path);
    loadData(await res.json());
  } catch { alert("è¼‰å…¥å¤±æ•—: " + path); }
}

loadVocabBtn.onclick = (e) => { e.stopPropagation(); loadVocabFile(vocabSelect.value); };

fsBtn.onclick = (e) => {
  e.stopPropagation();
  fullscreen = !fullscreen;
  root.classList.toggle("fullscreen", fullscreen);
  fsBtn.textContent = fullscreen ? "âœ•" : "â›¶";
  // åˆ‡æ›å…¨è¢å¹•å¾Œé«˜åº¦æ”¹è®Šï¼Œéœ€é‡æ–°è¨ˆç®—èƒ½æ”¾å¹¾å€‹å–®å­—
  setTimeout(render, 100); 
};

document.addEventListener('keydown', (e) => {
    if(e.code === 'Space' || e.code === 'Enter') {
        if(words.length > 0) {
            e.preventDefault();
            if(showChineseAlways) goNextPage();
            else {
                if(!pageRevealed) { 
                  pageRevealed = true; 
                  const rows = listContainer.querySelectorAll('.word-row');
                  rows.forEach(r => r.classList.add('revealed'));
                  hintText.textContent = "å†æ¬¡é»æ“Šç¿»ä¸‹ä¸€é ";
                }
                else goNextPage();
            }
        }
    }
});

initVocabList().then(()=>updateHardExportText());
</script>
</body>
</html>
